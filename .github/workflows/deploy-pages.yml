name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytz

      - name: Generate HTML content
        run: |
          mkdir -p docs
          touch docs/.nojekyll
          
          python << EOF
          import json
          import os
          from datetime import datetime
          import pytz
          
          def get_ist_time(utc_str=None):
              ist = pytz.timezone('Asia/Kolkata')
              if utc_str:
                  try:
                      # Parse the UTC time string
                      utc_dt = datetime.strptime(utc_str, "%Y-%m-%d %H:%M:%S")
                      # Make it aware of UTC timezone
                      utc_dt = pytz.utc.localize(utc_dt)
                      # Convert to IST
                      ist_dt = utc_dt.astimezone(ist)
                      return ist_dt.strftime("%Y-%m-%d %H:%M:%S IST")
                  except:
                      return utc_str + " (UTC)"
              else:
                  # Get current time in IST
                  return datetime.now(ist).strftime("%Y-%m-%d %H:%M:%S IST")
          
          html_start = '''
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>China News Bot</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .header {
                      background-color: white;
                      padding: 20px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      margin-bottom: 20px;
                  }
                  .date-section {
                      background-color: white;
                      padding: 20px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      margin-bottom: 20px;
                  }
                  .date-header {
                      background-color: #0366d6;
                      color: white;
                      padding: 10px 20px;
                      border-radius: 4px;
                      margin: -20px -20px 20px -20px;
                  }
                  .news-item {
                      border-bottom: 1px solid #eee;
                      padding: 15px 0;
                  }
                  .news-item:last-child {
                      border-bottom: none;
                  }
                  .chinese-title {
                      font-size: 1.1em;
                      color: #333;
                      margin-bottom: 5px;
                  }
                  .english-title {
                      color: #666;
                      margin-bottom: 10px;
                  }
                  .meta {
                      color: #888;
                      font-size: 0.9em;
                  }
                  .time {
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>China News Bot</h1>
                  <p class="time">Last checked: ''' + get_ist_time() + '''</p>
              </div>
          '''
          
          try:
              with open('headlines.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  
              # Get all dates and sort them in reverse order
              dates = sorted(data.get("headlines", {}).keys(), reverse=True)
              
              if dates:
                  for date in dates:
                      news_items = data["headlines"][date]
                      
                      # Sort news items by their timestamp if available
                      news_items = sorted(news_items, 
                                       key=lambda x: x.get('date', ''),
                                       reverse=True)
                      
                      # Create section for this date
                      section = f'''
                      <div class="date-section">
                          <h2 class="date-header">{date}</h2>
                      '''
                      
                      for item in news_items:
                          # Convert the time to IST
                          time_str = get_ist_time(item.get('date', '')) if item.get('date') else ''
                          section += f'''
                          <div class="news-item">
                              <div class="time">{time_str}</div>
                              <div class="chinese-title">{item["chinese_title"]}</div>
                              <div class="english-title">{item["english_title"]}</div>
                              <div class="meta">
                                  Source: {item["source"]} | 
                                  <a href="{item["url"]}" target="_blank">Read More</a>
                              </div>
                          </div>
                          '''
                      
                      section += '</div>'
                      html_start += section
              else:
                  html_start += '<div class="date-section"><p>No news updates available.</p></div>'
                  
          except FileNotFoundError:
              html_start += '<div class="date-section"><p>No news data found.</p></div>'
          except Exception as e:
              html_start += f'<div class="date-section"><p>Error loading news: {str(e)}</p></div>'
          
          html_end = '''
          </body>
          </html>
          '''
          
          with open('docs/index.html', 'w', encoding='utf-8') as f:
              f.write(html_start + html_end)
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 